#!/bin/sh

# initialize mariadb with this attributes
mysql_install_db --user=mysql --datadir=/var/lib/mysql

# start mariadb in the background
mysqld_safe &



# mysql_secure_installation <<EOF
# y
# $mariadb_root_password
# $mariadb_root_password
# y
# y
# y
# y
# EOF

# root password
# new root password
# Confirm root password
# Remove anonymous users
# Disallow root login remotely
# Remove test database and access to it
# Reload privilege tables now

mysql -u root -p$mariadb_root_password -e "CREATE DATABASE wp;CREATE USER 'wp_user'@'wordpress' IDENTIFIED BY '$wp_user_password';GRANT ALL PRIVILEGES ON wp.* TO 'db_user'@'wordpress';"

# restart mariadb in the forground
killall mariadbd
mysqld_safe





if [ ! -d "/var/lib/mysql/mysql" ]; then
    echo "Initializing database..."
    mysql_install_db --user=mysql --datadir=/var/lib/mysql > /dev/null
    echo "Database initialized."

    # Start MariaDB temporarily
    mysqld_safe --skip-networking &
    sleep 5

    # Create the WordPress database and user
    echo "Setting up the database..."
    mysql -u root <<EOF
    CREATE DATABASE IF NOT EXISTS wp;
    CREATE USER IF NOT EXISTS 'wp_user'@'%' IDENTIFIED BY 'password';
    GRANT ALL PRIVILEGES ON wp.* TO 'wp_user'@'%';
    FLUSH PRIVILEGES;
EOF

    # Shutdown the temporary MariaDB instance
    mysqladmin -u root shutdown
    echo "Database setup complete."
# fi

# Start MariaDB and make it the foreground process (PID 1)
exec mysqld --user=mysql --console


mysql_secure_installation <<EOF
    
    n
    y
    aaa
    aaa
    y
    y
    y
    y
EOF